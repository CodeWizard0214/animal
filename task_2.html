<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <link
      rel="stylesheet"
      href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css"
    />
    <title>Animal Show</title>
  </head>
  <body>
    <div class="container mt-5">
      Current Location :
      <div id="currentLocation">US-NY</div>
      <div id="birdInfoContainer" class="mt-3 row"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script>
      const apiKey = "3pn0jnrpfjre";

      async function getGlobalSightings(countryCode, maxResults) {
        const url = `https://api.ebird.org/v2/data/obs/${countryCode}/recent?includeProvisional=false&maxResults=${maxResults}`;
        const headers = new Headers({
          "X-eBirdApiToken": apiKey,
        });

        try {
          const response = await fetch(url, { headers });
          const data = await response.json();
          // const promises =
          // let locations = [];
          // for (let i = 0; i < data.length; i++) {
          //   const locationId = data[i].locId;
          //   const locResult = await getLocationInfo(locationId);
          //   console.log(locResult)
          //   locations.push(locResult.parent);
          // }
          let speciesArr = [];
          for (let i = 0; i < data.length; i++) {
            speciesArr.push(data[i].speciesCode);
          }
          const speciesString = speciesArr.join(",");
          const result = await getBirdPhoto(speciesString);
          const keys = Object.keys(result);
          let photos = [];
          for (let i = 0; i < keys.length; i++) {
            const assetId = result[keys[i]].assetId;
            const photoUrl = `https://cdn.download.ams.birds.cornell.edu/api/v2/asset/${assetId}/2400`;
            photos.push(photoUrl);
          }
          const res = data.map((item, idx) => {
            return { ...item, photoSrc: photos[idx] };
          });
          return res;
        } catch (error) {
          console.error("Error fetching recent sightings:", error);
        }
      }

      async function getBirdPhoto(speciesCode) {
        const url =
          "https://marketplaceapi.rareoasis.io/api/v1/collection/animalAsset/";
        const params = {
          key: "PUB1258538706",
          speciesCode: speciesCode,
          mediaType: "imageEssentialSet",
        };
        try {
          const queryString = new URLSearchParams(params).toString();
          const response = await fetch(`${url}?${queryString}`);
          return await response.json();
        } catch (error) {
          console.error("Error fetching", error);
        }
      }

      async function getLocationInfo(locId) {
        const url = `https://api.ebird.org/v2/ref/region/info/${locId}`;
        const headers = new Headers({
          "X-eBirdApiToken": apiKey,
        });
        try {
          const response = await fetch(url, { headers });
          const data = await response.json();
          return data;
        } catch (error) {
          console.log("Error fetching location info", error);
        }
      }
      const fetchData = async (countryCode = "US-NY") => {
        const maxResults = 10;
        const recentSightings = await getGlobalSightings(
          countryCode,
          maxResults
        );
        const currentLocation = document.getElementById("currentLocation");
        currentLocation.innerHTML = countryCode;
        const birdInfoContainer = document.getElementById("birdInfoContainer");
        let birdInfo = "";
        for (let i = 0; i < recentSightings.length; i++) {
          const data = recentSightings[i];
          birdInfo += `<div class="col-md-4 mb-4">
                        <div class="card">
                            <img src="${data.photoSrc}" class="card-img-top" alt="Animal 1">
                            <div class="card-body">
                            <h5 class="card-title">${data.comName}</h5>
                            <p class="card-text">Locatiion: ${data.locName}</p>
                            </div>
                        </div>
                        </div>`;
        }
        birdInfoContainer.innerHTML = birdInfo;
      };

      (() => {
        let i = 0;
        const countryCodes = ["US-NY", "UA", "CN", "US-CA"];
        fetchData();
        setInterval(() => {
          i = i + 1;
          fetchData(countryCodes[i % 3]);
        }, 5000);
      })();
    </script>
  </body>
</html>
