<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bird Sightings</title>
    <style>
      img {
        max-width: 100%;
        height: auto;
        margin-top: 10px;
      }
    </style>
  </head>
  <body>
    <!-- Container for displaying bird information -->
    <div id="birdInfoContainer"></div>

    <script>
      // API key for eBird API
      const apiKey = "3pn0jnrpfjre";

      // Function to make API calls and retrieve recent bird sightings
      async function getRecentSightings(lat, lng, dist, maxResults) {
        const url = `https://api.ebird.org/v2/data/obs/geo/recent?lat=${lat}&lng=${lng}&dist=${dist}&category=species&includeProvisional=false&maxResults=${maxResults}`;
        const headers = new Headers({
          "X-eBirdApiToken": apiKey,
        });

        try {
          const response = await fetch(url, { headers });
          const data = await response.json();
          return data;
        } catch (error) {
          console.error("Error fetching recent sightings:", error);
        }
      }

      // Function to get bird photo using curated media API
      async function getBirdPhoto(speciesCode) {
        const mediaUrl = "https://taxonomy.api.macaulaylibrary.org/media";
        const key = "PUB1258538706";
        const mediaType = "imageEssentialSet";

        const url = `${mediaUrl}?key=${key}&speciesCode=${speciesCode}&mediaType=${mediaType}`;
        console.log(url, "----------------");

        try {
          const response = await fetch(url);
          const data = await response.json();
          console.log(data, "++++++++++++++++++++++");

          if (data && speciesCode in data) {
            const assetId = data[speciesCode].assetId;
            const photoUrl = `https://cdn.download.ams.birds.cornell.edu/api/v2/asset/${assetId}/2400`;
            return photoUrl;
          } else {
            return null;
          }
        } catch (error) {
          console.error("Error fetching bird photo:", error);
        }
      }

      // Function to display bird information
      async function displayBirdInfo(bird) {
        const birdInfoContainer = document.getElementById("birdInfoContainer");

        const infoDiv = document.createElement("div");
        infoDiv.innerHTML = `
        <p><strong>Common Name:</strong> ${bird.comName}</p>
        <p><strong>Location Name:</strong> ${bird.locName}</p>
    `;

        // Get bird photo
        const photoUrl = await getBirdPhoto(bird.speciesCode);
        if (photoUrl) {
          const img = document.createElement("img");
          img.src = photoUrl;
          infoDiv.appendChild(img);
        } else {
          infoDiv.innerHTML += "<p>No photo available</p>";
        }

        birdInfoContainer.appendChild(infoDiv);
      }

      // Part one: Display recent bird sightings
      const lat = 42.478572;
      const lng = -76.45152;
      const dist = 1;
      const maxResults = 50;

      (async () => {
        var options = {
          method: "GET",
          headers: {
            Accept: "*/*",
          },
        };

        var url = "http://localhost:1871/api/v1/collection/animalAsset/";
        const params = {
          key: "PUB1258538706",
          speciesCode: "bkbwar",
          mediaType: "imageEssentialSet",
        };
        const queryString = new URLSearchParams(params).toString();
        fetch(`${url}?${queryString}`)
          .then((response) => {
            if (!response.ok) {
              throw new Error("Network response was not ok");
            }
            return response.json();
          })
          .then((data) => {
            console.log(data);
          })
          .catch((error) => {
            console.error(
              "There was a problem with the fetch operation:",
              error
            );
          });

        // const recentSightings = await getRecentSightings(lat, lng, dist, maxResults);

        // for (let i = 0; i < recentSightings.length; i++) {
        //     if (i % 10 === 0 && i !== 0) {
        //         await new Promise(resolve => setTimeout(resolve, 5000));  // Pause every 10 birds for 5 seconds
        //     }
        //     await displayBirdInfo(recentSightings[i]);
        // }
      })();
    </script>
  </body>
</html>
